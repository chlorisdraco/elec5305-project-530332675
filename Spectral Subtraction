import numpy as np
import soundfile as sf
from scipy.signal import stft, istft

def spectral_subtraction(noisy, fs, frame_len=0.02, hop_len=0.01, alpha=1.0):
    """
    Simple STFT-domain Spectral Subtraction.
    alpha = over-subtraction factor (1.0 = standard, >1 reduces more noise but adds distortion).
    """
    n_fft = int(round(frame_len * fs))
    hop = int(round(hop_len * fs))

    # STFT
    _, _, Y = stft(noisy, fs=fs, nperseg=n_fft, noverlap=n_fft-hop, window='hann')

    # Noise estimate: minimum statistics (very rough)
    Pn = np.min(np.abs(Y)**2, axis=1, keepdims=True)

    # Power spectral subtraction
    S_hat = np.abs(Y)**2 - alpha * Pn
    S_hat = np.maximum(S_hat, 1e-12)  # avoid negative values

    # Reconstruct spectrum magnitude + original phase
    Z = np.sqrt(S_hat) * np.exp(1j * np.angle(Y))

    # ISTFT
    _, enhanced = istft(Z, fs=fs, nperseg=n_fft, noverlap=n_fft-hop, window='hann')
    return enhanced.astype(np.float32)

